select t0.vunetid, (t3.depo-t0.cost) as balance, t0.last, t3.pend from (select vunetid, sum(cost) as cost, max(date) as last from drinks group by vunetid) t0 left join (select t1.vunetid, t1.depo, t2.pend from (select vunetid, sum(deposit) as depo from deposits where status="APPROVED" group by vunetid) t1 left join (select vunetid, sum(deposit) as pend from deposits where status="PENDING" group by vunetid) t2 on t1.vunetid=t2.vunetid) t3 on t0.vunetid = t3.vunetid;
select vunetid, (depo-cost) as balance, last, pend from (select vunetid, sum(cost) as cost, max(date) as last from drinks group by vunetid) left join (select id1 as id3, depo, pend from (select vunetid as id1, sum(deposit) as depo from deposits where status="APPROVED" group by vunetid) left join (select vunetid as id2, sum(deposit) as pend from deposits where status="PENDING" group by vunetid) on id1=id2) on vunetid = id3;
